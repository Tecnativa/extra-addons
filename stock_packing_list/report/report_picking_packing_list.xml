<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="report_picking_packing_list_document">
        <t t-call="web.html_container">
            <t t-call="web.external_layout">
                <t t-set="o" t-value="o.with_context(lang=o.partner_id.lang)" />
                <t
                    t-set="partner"
                    t-value="o.partner_id or (o.move_lines and o.move_lines[0].partner_id) or False"
                />
                <div class="page">
                    <div class="row">
                        <div class="col-auto">
                            <div class="row">
                                <div t-if="o.name" class="col-auto" name="div_name">
                                    <strong>Number:</strong>
                                    <p t-field="o.name" />
                                </div>
                                <div
                                    t-if="o.sale_id"
                                    class="col-auto"
                                    name="div_sale_id"
                                >
                                    <strong>Order Number:</strong>
                                    <p t-field="o.sale_id" />
                                </div>
                                <div
                                    t-if="o.sale_id"
                                    class="col-auto"
                                    name="div_sale_id_date_order"
                                >
                                    <strong>Order Date:</strong>
                                    <p t-field="o.sale_id.date_order" />
                                </div>
                                <div
                                    t-if="not o.sale_id"
                                    class="col-auto"
                                    name="div_origin"
                                >
                                    <strong>Source Document:</strong>
                                    <p t-field="o.origin" />
                                </div>
                                <div
                                    t-if="o.date_done"
                                    class="col-auto"
                                    name="div_date_done"
                                >
                                    <strong>Date of Transfer:</strong>
                                    <p t-field="o.date_done" />
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-auto">
                                    <h2>Summary boxes:</h2>
                                </div>
                            </div>
                        </div>
                        <div
                            class="col-auto"
                            t-out="partner"
                            t-options='{"widget": "contact", "fields": ["address", "name", "phone"], "no_marker": True}'
                        />
                    </div>
                    <t
                        t-set="packing_list_item_ids_not_is_pallet"
                        t-value="o.packing_list_item_ids.filtered(lambda x: not x.is_pallet)"
                    />
                    <table
                        class="table table-sm"
                        style="margin: 0"
                        t-if="packing_list_item_ids_not_is_pallet"
                        name="packing_list_item_ids_not_is_pallet"
                    >
                        <thead>
                            <tr>
                                <th name="th_sm_items_count"><strong
                                    >Box Qty</strong></th>
                                <th name="th_sm_pallet_number"><strong
                                    >Pallet Number</strong></th>
                                <th
                                    name="th_sm_item_number"
                                    t-if="'item_number' in optional_columns"
                                ><strong>Box Number</strong></th>
                                <th name="th_sm_code"><strong>Product</strong></th>
                                <th name="th_sm_hs_code"><strong>HS Code</strong></th>
                                <th name="th_sm_lot"><strong>Lot</strong></th>
                                <th name="th_sm_qty" class="text-right"><strong
                                    >Net Weight (kg)</strong></th>
                                <th name="th_sm_weight" class="text-right"><strong
                                    >Gross Weight (kg)</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <t
                                t-foreach="packing_list_item_ids_not_is_pallet"
                                t-as="item"
                            >
                                <t t-set="detail_qty" t-value="0.0" />
                                <t
                                    t-set="detail_items"
                                    t-value="item.list_item_detail_ids.sorted(key=lambda ln: (ln.product_id.id, ln.lot_id.id))"
                                />
                                <t t-set="package_qty_set" t-value="False" />
                                <t t-foreach="detail_items" t-as="detail">
                                    <t
                                        t-set="detail_qty"
                                        t-value="detail_qty + detail.qty"
                                    />
                                    <tr
                                        name="tr_item_detail"
                                        t-if="detail_last or (detail.product_id, detail.lot_id) != (detail_items[detail_index + 1].product_id, detail_items[detail_index + 1].lot_id)"
                                    >
                                        <td>
                                            <span
                                                t-if="not package_qty_set"
                                                t-field="item.package_quantity"
                                            />
                                            <t t-set="package_qty_set" t-value="True" />
                                        </td>
                                        <td>
                                            <span t-field="item.pallet_number" />
                                        </td>
                                        <td t-if="'item_number' in optional_columns">
                                            <span t-field="item.item_number" />
                                            <t t-if="item.package_quantity &gt; 1">
                                               - <span
                                                    t-out="item.package_quantity + item.item_number - 1"
                                                />
                                            </t>
                                        </td>
                                        <td name="td_product">
                                            <span t-field="detail.product_id" />
                                        </td>
                                        <td>
                                            <span t-field="detail.product_id.hs_code" />
                                        </td>
                                        <td>
                                            <span t-field="detail.lot_id" />
                                        </td>
                                        <td class="text-right">
                                            <span
                                                t-out="detail_qty"
                                                t-options="{'widget': 'float', 'decimal_precision': 'Product Unit of Measure'}"
                                            />
                                        </td>
                                        <td class="text-right">
                                            <span t-field="item.weight" />
                                        </td>
                                        <t t-set="detail_qty" t-value="0.0" />
                                    </tr>
                                </t>
                            </t>
                        </tbody>
                        <tfoot>
                            <tr class="font-weight-bold">
                                <td />
                                <td />
                                <td t-if="'item_number' in optional_columns" />
                                <td />
                                <td />
                                <td name="tf_total">TOTAL</td>
                                <td class="text-right">
                                    <span
                                        t-out="round(sum(packing_list_item_ids_not_is_pallet.list_item_detail_ids.mapped('qty')),2)"
                                    />
                                </td>
                                <td name="tf_item_weight" class="text-right">
                                    <span
                                        t-out="round(sum(packing_list_item_ids_not_is_pallet.mapped('weight')),2)"
                                    />
                                </td>
                            </tr>
                        </tfoot>
                    </table>

                    <t
                        t-set="packing_list_item_ids_is_pallet"
                        t-value="o.packing_list_item_ids.filtered(lambda x: x.is_pallet)"
                    />
                    <h2>Summary pallet:</h2>
                    <table
                        class="table table-sm"
                        style="margin: 0"
                        t-if="packing_list_item_ids_is_pallet"
                        name="packing_list_item_ids_is_pallet"
                    >
                        <thead>
                            <tr>
                                <th name="th_sm_pallet_number"><strong
                                    >Pallet Number</strong></th>
                                <th name="th_sm_weight" class="text-right"><strong
                                    >Weight (kg)</strong></th>
                                <th name="th_sm_size"><strong>Size (cm)</strong></th>
                                <th name="th_sm_volume" class="text-right"><strong
                                    >Volume (m3)</strong></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr t-foreach="packing_list_item_ids_is_pallet" t-as="box">
                                <td>
                                    <span t-field="box.pallet_number" />
                                </td>
                                <td class="text-right">
                                    <span
                                        t-out="sum(packing_list_item_ids_is_pallet.filtered(lambda x: x.pallet_number == box.pallet_number).mapped('weight'))"
                                    />
                                </td>
                                <td>
                                    <span t-field="box.item_size" />
                                </td>
                                <td class="text-right">
                                    <span t-field="box.volume" />
                                </td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="font-weight-bold">
                                <td>TOTAL</td>
                                <td class="text-right">
                                    <span
                                        t-out="sum(packing_list_item_ids_is_pallet.mapped('total_pallet_weight'))"
                                    />
                                </td>
                                <td />
                                <td />
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </t>
         </t>
    </template>
    <template id="report_picking_packing_list">
        <t t-foreach="docs" t-as="o">
            <t
                t-call="stock_packing_list.report_picking_packing_list_document"
                t-lang="o.partner_id.lang"
            >
                <t t-set="optional_columns" t-value="[]" />
            </t>
        </t>
    </template>
</odoo>
